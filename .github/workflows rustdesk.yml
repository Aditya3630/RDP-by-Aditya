name: RustDesk RDP Stable 6H

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'   # à¤¹à¤° 6 à¤˜à¤‚à¤Ÿà¥‡ à¤®à¥‡à¤‚ auto restart

jobs:
  build:
    name: ğŸš€ Deploy RustDesk Client
    runs-on: windows-latest
    timeout-minutes: 360

    env:
      RUSTDESK_URL: "https://github.com/rustdesk/rustdesk/releases/download/1.4.1/rustdesk-1.4.1-x86_64.msi"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare folders
        shell: powershell
        run: |
          New-Item -ItemType Directory -Force -Path rd_files, logs | Out-Null

      - name: Download RustDesk
        shell: powershell
        run: |
          $url = "${{ env.RUSTDESK_URL }}"
          if ($url -eq "") {
            Write-Host "â— RUSTDESK_URL not set!" -ForegroundColor Red
            exit 1
          }
          $out = "rd_files\rustdesk_installer.msi"
          Write-Host "â¬‡ï¸ Downloading RustDesk MSI from $url â€¦"
          Invoke-WebRequest -Uri $url -OutFile $out -UseBasicParsing
          if (-not (Test-Path $out)) {
            Write-Host "âŒ Download failed!"
            exit 1
          } else {
            Write-Host "âœ… Downloaded RustDesk installer."
          }

      - name: Install RustDesk silently
        shell: powershell
        run: |
          $msi = "rd_files\rustdesk_installer.msi"
          if (Test-Path $msi) {
            Write-Host "âš¡ Installing RustDesk silentlyâ€¦"
            Start-Process msiexec.exe -ArgumentList "/i", $msi, "/quiet", "/norestart" -Wait
            Write-Host "âœ… RustDesk installation done."
          } else {
            Write-Host "âŒ Installer MSI not found!"
            exit 1
          }

      - name: Enable Remote Desktop (optional)
        shell: powershell
        run: |
          Write-Host "ğŸ”“ Enabling Windows Remote Desktop (optional)â€¦"
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop" -ErrorAction SilentlyContinue
          net user runneradmin TheDisa1a || Write-Host "User set step skipped or already exists"

      - name: Start RustDesk
        shell: powershell
        run: |
          $exe = Get-ChildItem -Path "C:\Program Files\RustDesk" -Recurse -Filter "rustdesk.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($exe) {
            Write-Host "â–¶ï¸ Starting RustDesk client: $($exe.FullName)"
            Start-Process -FilePath $exe.FullName -WindowStyle Minimized
            Start-Sleep -Seconds 5
            Write-Host "âœ… RustDesk started."
          } else {
            Write-Host "âŒ Could not find RustDesk executable in default install folder."
            exit 1
          }

      - name: Show Connection Info
        shell: powershell
        run: |
          Write-Host ""
          Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan
          Write-Host "â•‘     ğŸš€ RUSTDESK CLIENT RUNNING     â•‘" -ForegroundColor Cyan
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
          Write-Host "Use RustDesk to connect via public or self-hosted servers."
          Write-Host ""

      - name: Keep Session Alive (optional)
        shell: powershell
        run: |
          Start-Job -ScriptBlock { while ($true) { Start-Sleep -Seconds 300 } } | Out-Null
          Write-Host "ğŸ”„ Keepalive loop started."
